/**
 * Created by imdante on 2016/9/15.
 */
$.AMUI.progress.start();
$(document).ready(function () {

    //设置表单提交禁用状态
    $(':submit').on('click', function () {
        $(this).prepend('<i class="am-icon-spinner am-icon-pulse"></i>').addClass('am-disabled');
        setTimeout('reSubmitState()', 5000);
    });
    //ajax提交表单
    $(document).on('click', '[data-ajax-submit]', function () {
        $(this).prepend('<i class="am-icon-spinner am-icon-pulse"></i>').addClass('am-disabled');
        var elm = $(this).data('ajax-submit');
        var $form = $(elm);
        if ($form['0'].checkValidity()) {
            var data = $form.serialize();
            var url = $form.attr('action');
            pform(url, data);
        } else {
            showAlert(403, '请填写必填字段');
        }
        setTimeout('reSubmitState()', 5000);
        return false;
    });
    // end ajax
    //删除设置
    $(document).on('click', '[data-del]', function () {
        var json = $(this).data('del');
        var obj = json_to_obj(json);
        var confirmButton = $('#' + obj.target);
        confirmButton.find('[data-am-modal-confirm]').attr('data-del-confirm', json);
        showModel(obj.target);
    });

    $(document).on('click', '[data-del-confirm]', function () {
        var json = $(this).data('del-confirm');
        var obj = json_to_obj(json);
        gform(obj.url, {id: obj.id}, function (res) {
            showAlert(res.code, res.msg, res.code);
        })
    });
    // end delete

    $(document).on('click', '[data-pid]', function () {
        var json = $(this).data('pid');
        var obj = json_to_obj(json);
        $('#' + obj.target).find('[name="pid"]').attr('value', obj.id);
        showModel(obj.target);
    });
    $(document).on('click', '.am-spm a,a.am-spm', function () {
        window.location.href = $(this).attr('href') + '?spm=' + spm;
        return false;
    })
    $.AMUI.progress.done();
});

//重置表单状态
function reSubmitState() {
    $(':submit,[data-ajax-submit]').removeClass('am-disabled').find('i').remove();
}

/**
 * json转object对象
 * @param json
 * @returns {Object}
 */
function json_to_obj(json) {
    return eval('(' + json + ')');
}

/**
 * 刷新验证码
 */
function refreshVerify() {
    //重载验证码
    var time = new Date().getTime();
    document.getElementById('verifyImg').src = '/common/helper/verify?time=' + time;
}


/**
 *清空缓存
 */
function clear_cache_log_temp() {
    gform('/common/helper/clear_cache_log_temp');
}
/**
 * post提交数据
 * @param url
 * @param data
 */
function pform(url, data) {
    $.post(url, data, function (json) {
        showAlert(json.code, json.msg, json.code, json.url);
    })
}
/**
 * get 方式提交数据
 * @param url
 * @param data
 */
function gform(url, data) {
    $.get(url, data, function (callback) {
        showAlert(callback.code, callback.msg, callback.code);
    })
}

function submitForm(e, form) {

}
/**
 * 提示框
 * @param code
 * @param msg
 * @param refresh
 */
function showAlert(code, msg, refresh, url) {
    var alert_success = $('.am-alert-success');
    var alert_error = $('.am-alert-danger');
    var alert_warning = $('.am-alert-warning');
    var alert;
    switch (code) {
        case 200:
            alert = alert_success;
            break;
        case 403 || 404:
            alert = alert_warning;
            break;
        default:
            alert = alert_error;
            break;
    }
    alert.find('p').html(msg);
    alert.fadeIn().delay(5000).fadeOut();
    //console.log(url);

    if (url) {
        setTimeout("tourl(\'" + url + "\')", 1000);
    }
    if (refresh == 200) {
        setTimeout("window.location.reload()", 2000);
    }
}
/**
 * 打开模态窗口
 * @param name
 * @param w
 */
function showModel(name, w) {
    $('#' + name).modal({width: w}, 'open');
}
/**
 * 转跳到url
 * @param url
 */
function tourl(url) {
    window.location.href = url;
}